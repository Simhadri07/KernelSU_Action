name: Kernel Builder

on:
  push:  # Automatically trigger on every push
    branches:
      - lineage-21  # Replace with the branch(es) you want to monitor
  pull_request:  # Automatically trigger on pull requests to the specified branch
    branches:
      - lineage-21

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Kernel Source
        uses: actions/checkout@v3
        with:
          repository: xiaomi-mediatek-devs/android_kernel_xiaomi_mt6877
          ref: lineage-21

      - name: Setup Build Environment
        run: |
          sudo apt update
          sudo apt install -y build-essential gcc clang ccache libncurses5-dev libssl-dev bison flex bc
          mkdir -p $GITHUB_WORKSPACE/output

      - name: Build Kernel
        env:
          CONFIG_ENV: config.env
        run: |
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export PATH=$PATH:/usr/lib/llvm-14/bin
          make ruby_defconfig
          make -j$(nproc) Image.gz-dtb

      - name: Package Kernel with AnyKernel3
        if: success()
        run: |
          git clone https://github.com/osm0sis/AnyKernel3 $GITHUB_WORKSPACE/anykernel
          cp arch/arm64/boot/Image.gz-dtb $GITHUB_WORKSPACE/anykernel/
          cd $GITHUB_WORKSPACE/anykernel
          zip -r9 kernel.zip .

      - name: Upload Kernel Artifact
        uses: actions/upload-artifact@v3
        with:
          name: compiled-kernel
          path: $GITHUB_WORKSPACE/anykernel/kernel.zip
